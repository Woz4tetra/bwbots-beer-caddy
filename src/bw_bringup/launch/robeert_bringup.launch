<?xml version="1.0" encoding="UTF-8"?>
<launch>
    <arg name="map_name" default="$(env ROS_MAP_NAME)"/>
    <arg name="robot_name" default="$(env ROBOT)"/>

    <include file="$(find bw_description)/launch/bw_description.launch">
        <arg name="model" value="$(find bw_description)/urdf/$(arg robot_name).urdf.xml"/>
        <arg name="joint_names" value="$(find bw_bringup)/config/$(arg robot_name)/joints.yaml"/>
    </include>
    <include file="$(find bw_bringup)/config/$(arg robot_name)/static_transforms_$(arg robot_name).launch"/>
    <include file="$(find bw_description)/launch/imu_joint.launch">
        <arg name="combine_with_odom" value="true"/>
    </include>

    <include file="$(find bw_tunnel)/launch/bw_tunnel.launch">
        <arg name="publish_odom_tf" value="false"/>
        <arg name="robot_address" value="/dev/serial/by-id/usb-Teensyduino_USB_Serial_12396120-if00"/>
        <arg name="joint_names" value="$(find bw_bringup)/config/$(arg robot_name)/joints.yaml"/>
    </include>
    <include file="$(find bw_tunnel)/launch/twist_mux.launch"/>

    <include file="$(find bw_load_cell)/launch/bw_load_cell.launch">
        <arg name="config_path" default="$(find bw_bringup)/config/$(arg robot_name)/load_cell.yaml"/>
    </include>

    <group ns="laser">
        <include file="$(find bw_rplidar)/launch/bw_rplidar_s1.launch">
            <arg name="serial_port" value="/dev/serial/by-id/usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0"/>
            <arg name="lidar_node_name" value="$(arg robot_name)_rplidar"/>
            <arg name="laser_frame_id" value="laser"/>
        </include>

        <node pkg="laser_filters" type="scan_to_scan_filter_chain" name="laser_filter">
            <rosparam command="load" file="$(find bw_bringup)/config/$(arg robot_name)/laser_filter.yaml" />
        </node>
    </group>

    <include file="$(find bw_move_base)/launch/bw_move_base.launch"/>
    <!-- <include file="$(find bw_behaviors)/launch/bw_behaviors.launch"/> -->
    <include file="$(find bw_zed)/launch/zed2.launch"/>

    <include file="$(find bw_waypoints)/launch/bw_waypoints.launch">
        <arg name="waypoints_path" value="$(find bw_data)/waypoints/$(env ROS_MAP_NAME)"/>
    </include>

    <include file="$(find bw_yolo)/launch/label_publisher.launch"/>
    <include file="$(find bw_dispensers)/launch/bw_dispensers.launch"/>

    <include file="$(find bw_laser_slam)/launch/bw_laser_slam.launch">
        <arg name="mode" value="localize"/>
        <arg name="map_name" value="$(arg map_name)"/>
        <arg name="laser_scan_topic" value="/laser/scan"/>
        <arg name="gmapping_config" value="$(find bw_bringup)/config/$(arg robot_name)/gmapping.yaml"/>
        <arg name="amcl_config" value="$(find bw_bringup)/config/$(arg robot_name)/amcl.yaml"/>
    </include>

    <group ns="bw">
        <node pkg="apriltag_ros" type="apriltag_ros_continuous_node" name="apriltags" required="false" output="screen">
            <rosparam command="load" file="$(find bw_bringup)/config/$(arg robot_name)/tags.yaml"/>
            <param name="publish_tag_detections_image" type="bool" value="false"/>
            <remap from="camera_info" to="/zed/rgb/camera_info"/>
            <remap from="image_rect" to="/zed/rgb/image_rect_color"/>
        </node>
    </group>

    <include file="$(find bw_filter)/launch/bw_filter.launch"/>
</launch>
